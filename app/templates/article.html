{% extends "base.html" %}
{% block title %}{{ article.title }} - çŸ¥ãƒªãƒAI{% endblock %}
{% block meta_description %}{{ meta_description|default(article.summary[:160] if article.summary else article.title)|e }}{% endblock %}
{% block meta_extra %}
    <link rel="canonical" href="{{ article_url }}">
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ article.title }} - çŸ¥ãƒªãƒAI">
    <meta property="og:description" content="{{ meta_description|e }}">
    <meta property="og:image" content="{{ og_image|default(image_url) }}">
    <meta property="og:url" content="{{ article_url }}">
    <meta property="og:site_name" content="çŸ¥ãƒªãƒAI">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ article.title }} - çŸ¥ãƒªãƒAI">
    <meta name="twitter:description" content="{{ meta_description|e }}">
    <meta name="twitter:image" content="{{ og_image|default(image_url) }}">
{% endblock %}

{% block content %}
<article class="article-detail">
    <header class="article-header">
        <a href="/" class="back-link">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
        <div class="article-meta">
            <span class="article-source">{{ article.source }}</span>
            <span class="article-badge">AIè§£èª¬ã¤ããƒªãƒãƒ¼ãƒˆ</span>
        </div>
        <h1 class="article-title">{{ article.title }}</h1>
        <h2 class="article-h2">{{ article.title }}ã¨ã¯ï¼Ÿ</h2>
    </header>

    <div class="article-hero">
        <img src="{{ image_url }}" alt="{{ article.title }}" class="article-image">
    </div>

    <div class="article-content-wrapper">
        <div class="article-main">
            <div id="article-inline-content" class="article-inline-content" data-fallback="{{ article.summary|e }}">
                {% if body_html %}
                {{ body_html|safe }}
                {% else %}
                <p class="article-text">{{ article.summary|default('')|e }}</p>
                {% endif %}
            </div>
            <div class="article-actions">
                <a href="{{ article.link }}" target="_blank" rel="noopener" class="read-original">
                    å‡ºå…¸ã‚’èª­ã‚€ â†’
                </a>
                <button type="button" id="btn-one-take" class="btn-one-take">æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’1æœ¬è¿½åŠ </button>
            </div>
        </div>
    </div>

    <section class="personas-section">
        <h2 class="personas-title">AIã®å¤šè§’çš„ãªè¦–ç‚¹ <span class="personas-hint">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰</span></h2>
        <div class="personas-grid">
            {% for p in personas %}
            <div class="persona-card" data-persona-id="{{ p.id }}" data-article-id="{{ article.id }}">
                <button type="button" class="persona-trigger" aria-expanded="false">
                    <span class="persona-emoji">{{ p.emoji }}</span>
                    <span class="persona-name">{{ p.name }}</span>
                    <span class="persona-arrow">â–¶</span>
                </button>
                <div class="persona-content" hidden>
                    <p class="persona-loading">èª­è¾¼ä¸­...</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <section class="next-read-section" aria-label="æ¬¡ã«èª­ã‚€è¨˜äº‹ãƒ»æ€è€ƒã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼">
        <h2 class="next-read-title">æ¬¡ã«èª­ã‚€è¨˜äº‹</h2>
        <nav class="next-article-nav" aria-label="ç¶šã‘ã¦èª­ã‚€">
            {% if prev_article %}
            <a href="/topic/{{ prev_article.id }}" class="next-article-link next-article-prev">â† å‰ã®è¨˜äº‹</a>
            {% endif %}
            {% if next_article %}
            <a href="/topic/{{ next_article.id }}" class="next-article-link next-article-next">æ¬¡ã®è¨˜äº‹ã¸ â†’</a>
            {% endif %}
            {% if not prev_article and not next_article %}
            <a href="/" class="next-article-link next-article-back">ä¸€è¦§ã«æˆ»ã‚‹</a>
            {% endif %}
        </nav>
        {% if related_articles|default([]) %}
        <h3 class="related-title">é–¢é€£ãƒˆãƒ”ãƒƒã‚¯ï¼ˆ{{ article.category }}ï¼‰</h3>
        <ul class="related-list">
            {% for rel in related_articles %}
            <li><a href="/topic/{{ rel.id }}">{{ rel.title }}</a></li>
            {% endfor %}
        </ul>
        {% endif %}
    </section>
</article>

<div id="midorman-float" class="midorman-float" aria-live="polite" hidden>
    <span class="midorman-float-avatar" aria-hidden="true">ğŸ™ï¸</span>
    <div class="midorman-float-inner">
        <p class="midorman-float-text" id="midorman-float-text"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const articleId = '{{ article.id }}';
    const ssrPersonas = {{ personas_data|tojson|safe }};

    function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function initScrollBubbles(container) {
        if (!container) return;
        var triggers = container.querySelectorAll('.scroll-trigger');
        if (triggers.length === 0) return;
        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (!entry.isIntersecting) return;
                var trigger = entry.target;
                var group = trigger.closest('.scroll-bubble-group');
                if (group) {
                    var wrap = group.querySelector('.midorman-bubble-wrap');
                    if (wrap) wrap.classList.add('is-visible');
                }
            });
        }, { rootMargin: '0px 0px -15% 0px', threshold: 0 });
        triggers.forEach(function(t) { observer.observe(t); });
    }

    function initMidormanFloat(container) {
        var floatEl = document.getElementById('midorman-float');
        var floatText = document.getElementById('midorman-float-text');
        if (!floatEl || !floatText) return;
        // text/explain å½¢å¼(.article-with-bubbles) ã¨ navigator å½¢å¼(.article-readflow) ã®ä¸¡æ–¹ã«å¯¾å¿œ
        var wraps = container.querySelectorAll('.scroll-bubble-group .midorman-bubble-wrap');
        if (wraps.length === 0) return;
        var lastHtml = '';
        var floatObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (!entry.isIntersecting) return;
                var wrap = entry.target;
                var textEl = wrap.querySelector('.midorman-bubble-text') || wrap.querySelector('.midorman-aside-body');
                if (textEl) {
                    lastHtml = textEl.innerHTML;
                    floatText.innerHTML = lastHtml;
                    floatEl.hidden = false;
                }
            });
        }, { rootMargin: '-10% 0px -50% 0px', threshold: 0 });
        wraps.forEach(function(w) { floatObserver.observe(w); });
        if (lastHtml) floatEl.hidden = false;
    }

    var hasSsr = document.getElementById('article-inline-content').querySelector('.article-text, .article-readflow') && ssrPersonas && ssrPersonas.length > 0;
    if (hasSsr) {
        document.querySelectorAll('.persona-card').forEach(function(card, i) {
            var content = card.querySelector('.persona-content');
            var opinion = ssrPersonas[i] || '';
            content.dataset.loaded = 'true';
            content.innerHTML = opinion
                ? '<p class="persona-opinion">' + escapeHtml(opinion).replace(/\n/g, '<br>') + '</p>'
                : '<p class="persona-error">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
        });
    } else {
    fetch('/api/article/' + articleId + '/explanations')
        .then(r => r.json())
        .then(function(data) {
            const el = document.getElementById('article-inline-content');
            var navLabels = { facts: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', background: 'èƒŒæ™¯', impact: 'å½±éŸ¿ç¯„å›²', prediction: 'äºˆæ¸¬', caution: 'æ³¨æ„' };
            if (!data.blocks || data.blocks.length === 0) {
                const fallback = el.dataset.fallback || '';
                el.innerHTML = '<p>' + escapeHtml(fallback) + '</p>';
            } else {
                var isNavigator = data.blocks.length && data.blocks[0].type === 'navigator_section';
                if (isNavigator) {
                    var paras = [], asides = [];
                    data.blocks.forEach(function(b) {
                        if (b.type === 'navigator_section' && b.section && navLabels[b.section]) {
                            var body = (b.content || '').trim() ? escapeHtml(b.content).replace(/\n/g, '<br>') : '';
                            if (b.section === 'facts' && body) {
                                paras = (b.content || '').trim().split(/\n\n+/).filter(function(p) { return p.trim(); });
                            } else if (b.section !== 'facts' && body) {
                                asides.push({ section: b.section, label: navLabels[b.section], body: body });
                            }
                        }
                    });
                    var factsHtml = '';
                    if (paras.length) {
                        factsHtml = '<div class="article-body">';
                        paras.forEach(function(p, i) {
                            factsHtml += '<p>' + escapeHtml(p).replace(/\n/g, '<br>') + '</p>';
                            if (asides[i]) {
                                var a = asides[i];
                                factsHtml += '<div class="scroll-bubble-group"><div class="scroll-trigger" data-aside-index="' + i + '" aria-hidden="true"></div><div class="midorman-bubble-wrap" data-aside-index="' + i + '"><div class="midorman-aside midorman-aside-' + escapeHtml(a.section) + '"><span class="midorman-aside-label">' + escapeHtml(a.label) + '</span><div class="midorman-aside-body">' + a.body + '</div></div></div></div>';
                            }
                        });
                        for (var j = paras.length; j < asides.length; j++) {
                            var a = asides[j];
                            factsHtml += '<div class="scroll-bubble-group"><div class="scroll-trigger" data-aside-index="' + j + '" aria-hidden="true"></div><div class="midorman-bubble-wrap" data-aside-index="' + j + '"><div class="midorman-aside midorman-aside-' + escapeHtml(a.section) + '"><span class="midorman-aside-label">' + escapeHtml(a.label) + '</span><div class="midorman-aside-body">' + a.body + '</div></div></div></div>';
                        }
                        factsHtml += '</div>';
                    }
                    el.innerHTML = '<div class="article-readflow">' + factsHtml + '</div>';
                    if (asides.length) initScrollBubbles(el);
                } else {
                    var html = '<div class="article-readflow article-with-bubbles">';
                    var explainIdx = 0;
                    data.blocks.forEach(function(b) {
                        if (b.type === 'explain') {
                            explainIdx++;
                            var c = escapeHtml(b.content || '').replace(/\n/g, '<br>');
                            html += '<h3 class="article-h3" id="explain-' + explainIdx + '">è¦ç‚¹ã®è§£èª¬</h3>';
                            html += '<div class="scroll-bubble-group"><div class="scroll-trigger" aria-hidden="true"></div><div class="midorman-bubble-wrap"><div class="midorman-bubble-above"><span class="midorman-bubble-avatar" aria-hidden="true">ğŸ™ï¸</span><div class="midorman-bubble-inner"><p class="midorman-bubble-text">' + c + '</p></div></div></div></div>';
                        } else if (b.type === 'text') {
                            var paras = (b.content || '').trim().split(/\n\n+/).filter(function(p) { return p.trim(); });
                            if (paras.length) paras.forEach(function(p) {
                                html += '<p class="article-text">' + escapeHtml(p).replace(/\n/g, '<br>') + '</p>';
                            });
                        }
                    });
                    html += '</div>';
                    el.innerHTML = html;
                    initScrollBubbles(el);
                    initMidormanFloat(el);
                }
            }

            // 5äººæ ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ¼ãƒ‰ã«ã‚»ãƒƒãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºã™ã‚‹ã ã‘ï¼‰
            const personas = data.personas || [];
            document.querySelectorAll('.persona-card').forEach(function(card, i) {
                const content = card.querySelector('.persona-content');
                const opinion = personas[i] || '';
                content.dataset.loaded = 'true';
                content.innerHTML = opinion
                    ? '<p class="persona-opinion">' + escapeHtml(opinion).replace(/\n/g, '<br>') + '</p>'
                    : '<p class="persona-error">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
            });
        })
        .catch(function() {
            const el = document.getElementById('article-inline-content');
            el.innerHTML = '<p>' + escapeHtml(el.dataset.fallback || '') + '</p>';
            document.querySelectorAll('.persona-content').forEach(function(c) {
                c.innerHTML = '<p class="persona-error">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            });
        });
    }

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•å¹ãå‡ºã—ï¼ˆSSRæ™‚ã¯åˆæœŸHTMLã«æ—¢ã«ã‚ã‚‹ï¼‰
    var contentEl = document.getElementById('article-inline-content');
    if (contentEl) {
        initScrollBubbles(contentEl);
        initMidormanFloat(contentEl);
    }

    // 5äººæ ¼ï¼šã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º/éè¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ï¼‰
    document.querySelectorAll('.persona-card').forEach(function(card) {
        const btn = card.querySelector('.persona-trigger');
        const content = card.querySelector('.persona-content');

        btn.addEventListener('click', function() {
            const isOpen = btn.getAttribute('aria-expanded') === 'true';
            if (isOpen) {
                content.hidden = true;
                btn.setAttribute('aria-expanded', 'false');
                btn.querySelector('.persona-arrow').textContent = 'â–¶';
            } else {
                content.hidden = false;
                btn.setAttribute('aria-expanded', 'true');
                btn.querySelector('.persona-arrow').textContent = 'â–¼';
            }
        });
    });

    // è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹ï¼šRSSã®æœ€æ–°1ä»¶ã‚’èª­ã¿è¾¼ã¿ã€AIãƒŸãƒ‰ãƒ«ãƒãƒ³ãŒè§£èª¬ã—ãŸè¨˜äº‹ã‚’1ä»¶è¿½åŠ ãƒ»å†ç”Ÿæˆ
    const btnOneTake = document.getElementById('btn-one-take');
    if (btnOneTake) {
        btnOneTake.addEventListener('click', function() {
            btnOneTake.disabled = true;
            btnOneTake.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
            fetch('/api/article/force-add-one')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'ok' && data.article_id) {
                        window.location.href = '/?added=1';
                    } else {
                        btnOneTake.disabled = false;
                        btnOneTake.textContent = 'æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’1æœ¬è¿½åŠ ';
                        var errMsg = data.message || (typeof data.detail === 'string' ? data.detail : '') || (Array.isArray(data.detail) ? data.detail.map(function(d){ return d.msg || d.loc; }).filter(Boolean).join(', ') : '') || 'å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        alert(errMsg);
                    }
                })
                .catch(function() {
                    btnOneTake.disabled = false;
                    btnOneTake.textContent = 'æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’1æœ¬è¿½åŠ ';
                    alert('å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        });
    }
});
</script>
{% endblock %}

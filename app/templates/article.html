{% extends "base.html" %}
{% block title %}{{ article.title }} - çŸ¥ãƒªãƒAI{% endblock %}
{% block meta_description %}{{ meta_description|default(article.summary[:160] if article.summary else article.title)|e }}{% endblock %}
{% block meta_extra %}
    <link rel="canonical" href="{{ article_url }}">
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ article.title }} - çŸ¥ãƒªãƒAI">
    <meta property="og:description" content="{{ meta_description|e }}">
    <meta property="og:image" content="{{ og_image|default(image_url) }}">
    <meta property="og:url" content="{{ article_url }}">
    <meta property="og:site_name" content="çŸ¥ãƒªãƒAI">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ article.title }} - çŸ¥ãƒªãƒAI">
    <meta name="twitter:description" content="{{ meta_description|e }}">
    <meta name="twitter:image" content="{{ og_image|default(image_url) }}">
{% endblock %}

{% block content %}
<article class="article-detail">
    <header class="article-header">
        <a href="/" class="back-link">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
        <div class="article-meta">
            <span class="article-source">{{ article.source }}</span>
            <span class="article-date">ğŸ•’ {{ article.published.strftime('%Y/%m/%d %H:%M') if article.published else '' }}</span>
            <span class="article-cat-badge">ğŸ· {{ article.category }}</span>
            <span class="article-badge">AIè§£èª¬ã¤ããƒªãƒãƒ¼ãƒˆ</span>
        </div>
        <h1 class="article-title">{{ article.title }}</h1>
        <div class="article-header-actions">
            <button type="button" class="save-article-btn" id="btn-save" data-id="{{ article.id }}" data-title="{{ article.title|e }}" data-summary="{{ (article.summary or '')[:100]|e }}">
                â­ ä¿å­˜
            </button>
        </div>
    </header>

    <div class="article-hero">
        <img src="{{ image_url }}" alt="{{ article.title }}" class="article-image">
    </div>

    {% if quick_understand %}
    <div class="quick-understand animate-fade-in">
        <h2 class="quick-understand-title">âš¡ ç§’é€Ÿç†è§£</h2>
        <div class="quick-understand-item">
            <span class="quick-understand-label">âœ… ä½•ãŒèµ·ããŸ</span>
            <span>{{ quick_understand.what }}</span>
        </div>
        <div class="quick-understand-item">
            <span class="quick-understand-label">â“ ãªãœ</span>
            <span>{{ quick_understand.why }}</span>
        </div>
        <div class="quick-understand-item">
            <span class="quick-understand-label">ğŸ”® ã©ã†ãªã‚‹</span>
            <span>{{ quick_understand.how }}</span>
        </div>
    </div>
    {% endif %}

    <div class="read-mode-switch">
        <button type="button" class="read-mode-btn is-active" data-mode="short">ğŸ“– 1åˆ†ã§ç†è§£</button>
        <button type="button" class="read-mode-btn" data-mode="deep">ğŸ“š 3åˆ†ã§æ·±æ˜ã‚Š</button>
    </div>

    <div class="article-content-wrapper">
        <div class="article-main">
            <div id="article-short-content" class="article-read-content">
                {% if short_summary %}
                <div class="short-summary-box">
                    <h3 class="short-summary-heading">ğŸ“ è¦ç‚¹ã¾ã¨ã‚</h3>
                    {{ short_summary|safe }}
                </div>
                {% else %}
                <div class="short-summary-box">
                    <h3 class="short-summary-heading">ğŸ“ è¦ç‚¹ã¾ã¨ã‚</h3>
                    <p class="article-text">{{ article.summary|default('')|e }}</p>
                </div>
                {% endif %}
            </div>
            <div id="article-deep-content" class="article-read-content" style="display:none;">
                <div id="article-inline-content" class="article-inline-content" data-fallback="{{ article.summary|e }}">
                    {% if body_html %}
                    {{ body_html|safe }}
                    {% else %}
                    <p class="article-text">{{ article.summary|default('')|e }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="article-actions">
                <a href="{{ article.link }}" target="_blank" rel="noopener" class="read-original">å‡ºå…¸ã‚’èª­ã‚€ â†’</a>
            </div>
        </div>
    </div>

    <section class="personas-section">
        <h2 class="personas-title">AIã®å¤šè§’çš„ãªè¦–ç‚¹ <span class="personas-hint">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰</span></h2>
        <div class="personas-grid">
            {% for p in personas %}
            <div class="persona-card" data-persona-id="{{ p.id }}" data-article-id="{{ article.id }}">
                <button type="button" class="persona-trigger" aria-expanded="false">
                    <span class="persona-emoji">{{ p.emoji }}</span>
                    <span class="persona-name">{{ p.name }}</span>
                    <span class="persona-arrow">â–¶</span>
                </button>
                <div class="persona-content" hidden>
                    <p class="persona-loading">èª­è¾¼ä¸­...</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    {% if vote_data %}
    <section class="vote-section" id="vote-section">
        <h2 class="vote-question">ğŸ’­ {{ vote_data.question }}</h2>
        <div class="vote-options" id="vote-options">
            {% for opt in vote_data.options %}
            <button type="button" class="vote-btn" data-vote="{{ opt.id }}">
                <span class="vote-label">{{ opt.label }}</span>
                <span class="vote-bar"><span class="vote-bar-fill" style="width:0%"></span></span>
                <span class="vote-pct">-</span>
            </button>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="article-navigation">
        {% if related_articles %}
        <div class="article-nav-section">
            <h3 class="article-nav-title">ğŸ“° é–¢é€£è¨˜äº‹</h3>
            <div class="news-grid nav-grid">
                {% for rel in related_articles[:3] %}
                <article class="news-card news-card-sm">
                    <a href="/topic/{{ rel.id }}" class="news-card-link">
                        <div class="news-card-body">
                            <span class="news-card-category-inline">{{ rel.category }}</span>
                            <h3 class="news-title">{{ rel.title }}</h3>
                        </div>
                    </a>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if same_category_articles %}
        <div class="article-nav-section">
            <h3 class="article-nav-title">ğŸ· {{ article.category }}ã®è¨˜äº‹</h3>
            <div class="news-grid nav-grid">
                {% for rel in same_category_articles[:3] %}
                <article class="news-card news-card-sm">
                    <a href="/topic/{{ rel.id }}" class="news-card-link">
                        <div class="news-card-body">
                            <span class="news-card-category-inline">{{ rel.category }}</span>
                            <h3 class="news-title">{{ rel.title }}</h3>
                        </div>
                    </a>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if ai_recommended %}
        <div class="article-nav-section">
            <h3 class="article-nav-title">ğŸ¤– AIãŠã™ã™ã‚</h3>
            <div class="news-grid nav-grid">
                {% for rel in ai_recommended[:3] %}
                <article class="news-card news-card-sm">
                    <a href="/topic/{{ rel.id }}" class="news-card-link">
                        <div class="news-card-body">
                            <span class="news-card-category-inline">{{ rel.category }}</span>
                            <h3 class="news-title">{{ rel.title }}</h3>
                        </div>
                    </a>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <nav class="next-article-nav" aria-label="ç¶šã‘ã¦èª­ã‚€">
            {% if prev_article %}
            <a href="/topic/{{ prev_article.id }}" class="next-article-link next-article-prev">â† å‰ã®è¨˜äº‹</a>
            {% endif %}
            {% if next_article %}
            <a href="/topic/{{ next_article.id }}" class="next-article-link next-article-next">æ¬¡ã®è¨˜äº‹ã¸ â†’</a>
            {% endif %}
        </nav>
    </section>
</article>

<div id="midorman-float" class="midorman-float" aria-live="polite" hidden>
    <span class="midorman-float-avatar" aria-hidden="true">ğŸ™ï¸</span>
    <div class="midorman-float-inner">
        <p class="midorman-float-text" id="midorman-float-text"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var articleId = '{{ article.id }}';
    var ssrPersonas = {{ personas_data|tojson|safe }};

    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    // Read mode switch
    var modeBtns = document.querySelectorAll('.read-mode-btn');
    var shortContent = document.getElementById('article-short-content');
    var deepContent = document.getElementById('article-deep-content');
    modeBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            var mode = this.getAttribute('data-mode');
            modeBtns.forEach(function(b) { b.classList.remove('is-active'); });
            this.classList.add('is-active');
            if (mode === 'short') {
                shortContent.style.display = '';
                deepContent.style.display = 'none';
            } else {
                shortContent.style.display = 'none';
                deepContent.style.display = '';
            }
        });
    });

    // Save button
    var saveBtn = document.getElementById('btn-save');
    if (saveBtn) {
        var saved = JSON.parse(localStorage.getItem('saved_articles') || '[]');
        var isSaved = saved.some(function(a) { return a.id === articleId; });
        if (isSaved) { saveBtn.classList.add('is-saved'); saveBtn.textContent = 'â­ ä¿å­˜æ¸ˆã¿'; }
        saveBtn.addEventListener('click', function() {
            var saved = JSON.parse(localStorage.getItem('saved_articles') || '[]');
            var idx = saved.findIndex(function(a) { return a.id === articleId; });
            if (idx >= 0) {
                saved.splice(idx, 1);
                this.classList.remove('is-saved');
                this.textContent = 'â­ ä¿å­˜';
            } else {
                saved.push({ id: articleId, title: this.dataset.title, summary: this.dataset.summary });
                this.classList.add('is-saved');
                this.textContent = 'â­ ä¿å­˜æ¸ˆã¿';
            }
            localStorage.setItem('saved_articles', JSON.stringify(saved));
        });
    }

    // Vote
    var voteSection = document.getElementById('vote-section');
    if (voteSection) {
        var voteBtns = voteSection.querySelectorAll('.vote-btn');
        var voteKey = 'vote_' + articleId;
        var existingVote = localStorage.getItem(voteKey);
        var votes = JSON.parse(localStorage.getItem('vote_counts_' + articleId) || '{}');
        function updateVoteDisplay() {
            var total = 0;
            for (var k in votes) total += votes[k];
            voteBtns.forEach(function(btn) {
                var vid = btn.dataset.vote;
                var count = votes[vid] || 0;
                var pct = total > 0 ? Math.round((count / total) * 100) : 0;
                btn.querySelector('.vote-bar-fill').style.width = pct + '%';
                btn.querySelector('.vote-pct').textContent = pct + '%';
                if (existingVote === vid) btn.classList.add('voted');
            });
        }
        if (existingVote) updateVoteDisplay();
        voteBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                if (existingVote) return;
                var vid = this.dataset.vote;
                existingVote = vid;
                localStorage.setItem(voteKey, vid);
                votes[vid] = (votes[vid] || 0) + 1;
                localStorage.setItem('vote_counts_' + articleId, JSON.stringify(votes));
                updateVoteDisplay();
            });
        });
    }

    function initMidormanFloat(container) {
        var floatEl = document.getElementById('midorman-float');
        var floatText = document.getElementById('midorman-float-text');
        if (!floatEl || !floatText) return;
        var dataEl = container.querySelector('.midorman-float-data');
        if (!dataEl) return;
        var items;
        try { items = JSON.parse(dataEl.textContent); } catch(e) { return; }
        if (!items || items.length === 0) return;
        var paras = container.querySelectorAll('.article-text[data-para]');
        if (paras.length === 0) return;
        var currentIdx = -1;
        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (!entry.isIntersecting) return;
                var idx = parseInt(entry.target.dataset.para, 10);
                var explainIdx = Math.min(Math.floor(idx * items.length / paras.length), items.length - 1);
                if (explainIdx !== currentIdx && explainIdx >= 0) {
                    currentIdx = explainIdx;
                    floatText.innerHTML = items[explainIdx].body;
                    floatEl.hidden = false;
                }
            });
        }, { rootMargin: '-10% 0px -50% 0px', threshold: 0 });
        paras.forEach(function(p) { observer.observe(p); });
    }

    var contentEl = document.getElementById('article-inline-content');
    if (contentEl) {
        initMidormanFloat(contentEl);
    }

    var hasSsr = contentEl && contentEl.querySelector('.article-text, .article-readflow') && ssrPersonas && ssrPersonas.length > 0;
    if (hasSsr) {
        document.querySelectorAll('.persona-card').forEach(function(card, i) {
            var content = card.querySelector('.persona-content');
            var opinion = ssrPersonas[i] || '';
            content.dataset.loaded = 'true';
            content.innerHTML = opinion
                ? '<p class="persona-opinion">' + escapeHtml(opinion).replace(/\n/g, '<br>') + '</p>'
                : '<p class="persona-error">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
        });
    } else {
        fetch('/api/article/' + articleId + '/explanations')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var el = document.getElementById('article-inline-content');
                if (!data.blocks || data.blocks.length === 0) {
                    el.innerHTML = '<p>' + escapeHtml(el.dataset.fallback || '') + '</p>';
                } else {
                    var navLabels = { facts: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', background: 'èƒŒæ™¯', impact: 'å½±éŸ¿ç¯„å›²', prediction: 'äºˆæ¸¬', caution: 'æ³¨æ„' };
                    var isNavigator = data.blocks[0].type === 'navigator_section';
                    var textParts = [];
                    var floatItems = [];
                    if (isNavigator) {
                        data.blocks.forEach(function(b) {
                            if (b.type !== 'navigator_section' || !b.section) return;
                            var body = (b.content || '').trim();
                            if (!body) return;
                            if (b.section === 'facts') {
                                body.split(/\n\n+/).filter(function(p) { return p.trim(); }).forEach(function(p) {
                                    textParts.push(escapeHtml(p).replace(/\n/g, '<br>'));
                                });
                            } else if (navLabels[b.section]) {
                                floatItems.push({ label: navLabels[b.section], body: escapeHtml(body).replace(/\n/g, '<br>') });
                            }
                        });
                    } else {
                        data.blocks.forEach(function(b) {
                            if (b.type === 'text') {
                                (b.content || '').trim().split(/\n\n+/).filter(function(p) { return p.trim(); }).forEach(function(p) {
                                    textParts.push(escapeHtml(p).replace(/\n/g, '<br>'));
                                });
                            } else if (b.type === 'explain') {
                                var c = (b.content || '').trim();
                                if (c) floatItems.push({ label: 'ãƒŸãƒ‰ãƒ«ãƒãƒ³', body: escapeHtml(c).replace(/\n/g, '<br>') });
                            }
                        });
                    }
                    var html = '<div class="article-readflow">';
                    textParts.forEach(function(p, i) {
                        html += '<p class="article-text" data-para="' + i + '">' + p + '</p>';
                    });
                    if (floatItems.length > 0) {
                        html += '<script type="application/json" class="midorman-float-data">' + JSON.stringify(floatItems) + '<\/script>';
                    }
                    html += '</div>';
                    el.innerHTML = html;
                    initMidormanFloat(el);
                }
                var personas = data.personas || [];
                document.querySelectorAll('.persona-card').forEach(function(card, i) {
                    var content = card.querySelector('.persona-content');
                    var opinion = personas[i] || '';
                    content.dataset.loaded = 'true';
                    content.innerHTML = opinion
                        ? '<p class="persona-opinion">' + escapeHtml(opinion).replace(/\n/g, '<br>') + '</p>'
                        : '<p class="persona-error">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
                });
            })
            .catch(function() {
                var el = document.getElementById('article-inline-content');
                el.innerHTML = '<p>' + escapeHtml(el.dataset.fallback || '') + '</p>';
            });
    }

    // Persona toggle
    document.querySelectorAll('.persona-card').forEach(function(card) {
        var btn = card.querySelector('.persona-trigger');
        var content = card.querySelector('.persona-content');
        btn.addEventListener('click', function() {
            var isOpen = btn.getAttribute('aria-expanded') === 'true';
            content.hidden = !isOpen;
            btn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
            btn.querySelector('.persona-arrow').textContent = isOpen ? 'â–¶' : 'â–¼';
        });
    });
});
</script>
{% endblock %}

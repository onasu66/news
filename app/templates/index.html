{% extends "base.html" %}
{% block title %}çŸ¥ãƒªãƒAI - æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIãŒçŸ¥çš„ã«è§£èª¬{% endblock %}
{% block meta_extra %}
    <meta property="og:type" content="website">
    <meta property="og:title" content="çŸ¥ãƒªãƒAI - æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIãŒçŸ¥çš„ã«è§£èª¬">
    <meta property="og:description" content="ä¿¡é ¼ãƒ¡ãƒ‡ã‚£ã‚¢ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’åé›†ã—ã€AIãŒèƒŒæ™¯ãƒ»ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã€‚">
    <meta property="og:image" content="{{ og_image|default('https://picsum.photos/1200/630') }}">
    <meta property="og:url" content="{{ site_url|default(request.url) }}/">
    <meta property="og:site_name" content="çŸ¥ãƒªãƒAI">
{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="hero-inner">
        <span class="hero-badge animate-fade-in">AIãŒè§£èª¬ã™ã‚‹çŸ¥çš„ãƒªãƒãƒ¼ãƒˆ</span>
        <h1 class="hero-title animate-slide-up">æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã€<br class="sp-only">AIãŒè§£èª¬</h1>
        <p class="hero-desc animate-slide-up delay-1">NHKãƒ»Reutersãƒ»èª­å£²ãªã©ä¿¡é ¼ãƒ¡ãƒ‡ã‚£ã‚¢ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’åé›†ã—ã€AIãŒèƒŒæ™¯ã‚„ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã—ã¾ã™ã€‚</p>
    </div>
</section>

<div class="page-layout">
    <div class="content-main">
        {% if search_keyword %}
        <div class="search-result-header">
            <p class="search-keyword-msg">ã€Œ{{ search_keyword }}ã€ã®é–¢é€£è¨˜äº‹</p>
            <a href="/" class="search-clear">Ã— ã‚¯ãƒªã‚¢</a>
        </div>
        {% endif %}

        <div class="genre-tabs-wrap" role="tablist" aria-label="ã‚¸ãƒ£ãƒ³ãƒ«ã§çµã‚Šè¾¼ã¿">
            <div class="genre-tabs-scroll">
                <button type="button" class="genre-tab is-active" role="tab" aria-selected="true" data-cat="all">ã™ã¹ã¦</button>
                {% for category, items in news_by_category %}
                <button type="button" class="genre-tab" role="tab" aria-selected="false" data-cat="{{ category }}">{{ category }}</button>
                {% endfor %}
            </div>
        </div>

        <div class="news-grid" id="news-grid">
            {% for category, items in news_by_category %}
            {% for item in items %}
            <article class="news-card animate-fade-in" data-category="{{ item.category }}">
                <a href="/topic/{{ item.id }}" class="news-card-link">
                    <div class="news-card-image">
                        <img src="{{ item.image_url or 'https://picsum.photos/400/225' }}" alt="{{ item.title }}" loading="lazy" onerror="this.src='https://picsum.photos/seed/{{ item.id }}/400/225'">
                        <span class="news-card-category">{{ item.category }}</span>
                    </div>
                    <div class="news-card-body">
                        <div class="news-card-meta">
                            <span class="news-card-time">ğŸ•’ {{ item.published.strftime('%m/%d %H:%M') if item.published else '' }}</span>
                            <span class="news-card-source">{{ item.source }}</span>
                        </div>
                        <h3 class="news-title">{{ item.title }}</h3>
                        <p class="news-summary-line">ğŸ‘€ {{ item.summary[:80] }}{% if item.summary|length > 80 %}...{% endif %}</p>
                        <div class="news-card-footer">
                            <span class="news-card-ai">âœ AIãŒè§£èª¬</span>
                            <span class="news-badge">AIè§£èª¬</span>
                        </div>
                    </div>
                </a>
            </article>
            {% endfor %}
            {% endfor %}
        </div>

        <div id="infinite-sentinel" style="height:1px;"></div>
        <div id="infinite-loader" class="infinite-loader" style="display:none;">
            <div class="loader-spinner"></div>
            <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        <div id="infinite-end" class="infinite-end" style="display:none;">
            <p>ã™ã¹ã¦ã®è¨˜äº‹ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ</p>
        </div>
    </div>

    <aside class="sidebar">
        <div class="trends-box">
            <h2 class="sidebar-title"><span class="icon-fire">ğŸ“ˆ</span> ã„ã¾æ¤œç´¢ã•ã‚Œã¦ã„ã‚‹</h2>
            <ul class="trends-list">
                {% for t in trends %}
                <li>
                    <a href="/?keyword={{ t.keyword|urlencode }}" class="trend-link-internal">
                        <span class="trend-source trend-{{ t.source }}">{{ 'ğŸ¦' if t.source == 'twitter' else 'ğŸ”' }}</span>
                        {{ t.keyword }}
                    </a>
                </li>
                {% else %}
                <li class="trends-empty">ãƒˆãƒ¬ãƒ³ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</li>
                {% endfor %}
            </ul>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Genre tab filtering
    var tabs = document.querySelectorAll('.genre-tab');
    var cards = document.querySelectorAll('.news-card');
    tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
            var cat = this.getAttribute('data-cat');
            tabs.forEach(function(t) { t.classList.remove('is-active'); t.setAttribute('aria-selected', 'false'); });
            this.classList.add('is-active');
            this.setAttribute('aria-selected', 'true');
            cards.forEach(function(card) {
                if (cat === 'all' || card.getAttribute('data-category') === cat) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    // Infinite scroll
    var page = {{ pagination.page }};
    var totalPages = {{ pagination.total_pages }};
    var loading = false;
    var loader = document.getElementById('infinite-loader');
    var endMsg = document.getElementById('infinite-end');
    var grid = document.getElementById('news-grid');
    var keyword = '{{ search_keyword|default("") }}';

    if (page >= totalPages) {
        if (endMsg && grid.children.length > 0) endMsg.style.display = 'block';
    }

    function loadMore() {
        if (loading || page >= totalPages) return;
        loading = true;
        loader.style.display = 'flex';
        page++;
        var url = '/api/news/page?page=' + page;
        if (keyword) url += '&keyword=' + encodeURIComponent(keyword);
        fetch(url).then(function(r) { return r.json(); }).then(function(data) {
            if (data.html) {
                grid.insertAdjacentHTML('beforeend', data.html);
                // Re-query cards for tab filtering
                cards = document.querySelectorAll('.news-card');
                var activeTab = document.querySelector('.genre-tab.is-active');
                if (activeTab) {
                    var cat = activeTab.getAttribute('data-cat');
                    if (cat !== 'all') {
                        cards.forEach(function(card) {
                            if (card.getAttribute('data-category') !== cat) card.style.display = 'none';
                        });
                    }
                }
            }
            if (page >= data.total_pages) {
                endMsg.style.display = 'block';
            }
            loading = false;
            loader.style.display = 'none';
        }).catch(function() {
            loading = false;
            loader.style.display = 'none';
        });
    }

    var sentinel = document.getElementById('infinite-sentinel');
    if (sentinel && 'IntersectionObserver' in window) {
        var obs = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting) loadMore();
        }, { rootMargin: '600px' });
        obs.observe(sentinel);
    }
})();
</script>
{% endblock %}

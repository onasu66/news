{% extends "base.html" %}
{% block title %}çŸ¥ãƒªãƒAI - æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIãŒçŸ¥çš„ã«è§£èª¬{% endblock %}
{% block meta_extra %}
    <meta property="og:type" content="website">
    <meta property="og:title" content="çŸ¥ãƒªãƒAI - æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIãŒçŸ¥çš„ã«è§£èª¬">
    <meta property="og:description" content="ä¿¡é ¼ãƒ¡ãƒ‡ã‚£ã‚¢ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’åé›†ã—ã€AIãŒèƒŒæ™¯ãƒ»ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã€‚çŸ¥çš„ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã§ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚‚ã£ã¨åˆ†ã‹ã‚‹ã€‚">
    <meta property="og:image" content="{{ og_image|default('https://picsum.photos/1200/630') }}">
    <meta property="og:url" content="{{ site_url|default(request.url) }}/">
    <meta property="og:site_name" content="çŸ¥ãƒªãƒAI">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="çŸ¥ãƒªãƒAI - æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIãŒçŸ¥çš„ã«è§£èª¬">
    <meta name="twitter:description" content="ä¿¡é ¼ãƒ¡ãƒ‡ã‚£ã‚¢ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’åé›†ã—ã€AIãŒèƒŒæ™¯ãƒ»ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã€‚çŸ¥çš„ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã§ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚‚ã£ã¨åˆ†ã‹ã‚‹ã€‚">
    <meta name="twitter:image" content="{{ og_image|default('https://picsum.photos/1200/630') }}">
{% endblock %}

{% block content %}
<div class="page-top">
    <div class="hero">
        <span class="hero-badge">AIãŒè§£èª¬ã™ã‚‹çŸ¥çš„ãƒªãƒãƒ¼ãƒˆ</span>
        <h1>æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã€AIãŒè§£èª¬</h1>
        <p class="hero-desc">NHKãƒ»Reutersãƒ»èª­å£²ãªã©ä¿¡é ¼ãƒ¡ãƒ‡ã‚£ã‚¢ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’åé›†ã—ã€AIãŒèƒŒæ™¯ã‚„ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã€‚ã²ã¨ã¤ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã€ŒçŸ¥ã®ãƒªãƒãƒ¼ãƒˆã€ã¨ã—ã¦ã€åˆ†ã‹ã‚Šã‚„ã™ããŠå±Šã‘ã—ã¾ã™ã€‚</p>
        <div class="hero-buttons">
            <button type="button" id="btn-add-article" class="btn-add-article">æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’è¿½åŠ </button>
            <button type="button" id="btn-rss-one" class="btn-rss-one" title="RSSã‚’å–å¾—ã—ã¦1ä»¶ã ã‘è¨˜äº‹åŒ–">æ‰‹å‹•ã§RSSå–å¾—ï¼ˆ1ä»¶ï¼‰</button>
        </div>

        <div class="added-one-box">
            <h2 class="added-one-title">æ³¨ç›®ã®1æœ¬</h2>
            {% if added_one %}
            <article class="added-one-card">
                <a href="/topic/{{ added_one.id }}" class="added-one-link">
                    <div class="added-one-image">
                        <img src="{{ added_one.image_url or 'https://picsum.photos/400/225' }}" alt="{{ added_one.title }}" loading="lazy" onerror="this.src='https://picsum.photos/seed/{{ added_one.id }}/400/225'">
                    </div>
                    <div class="added-one-body">
                        <span class="added-one-source">{{ added_one.source }}</span>
                        <h3 class="added-one-heading">{{ added_one.title }}</h3>
                        <p class="added-one-summary">{{ added_one.summary[:160] }}{% if added_one.summary|length > 160 %}...{% endif %}</p>
                        <span class="added-one-badge">AIè§£èª¬ã¤ã</span>
                    </div>
                </a>
            </article>
            {% else %}
            <p class="added-one-empty">ã¾ã ãƒªãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’è¿½åŠ ã€ã§æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIè§£èª¬ä»˜ãã§å–ã‚Šè¾¼ã¿ã¾ã™ã€‚</p>
            {% endif %}
        </div>
    </div>

    <aside class="trends-sidebar">
        <h2 class="sidebar-title">
            <span class="icon-fire">ğŸ“ˆ</span> ã„ã¾æ¤œç´¢ã•ã‚Œã¦ã„ã‚‹
        </h2>
        <ul class="trends-list">
            {% for t in trends %}
            <li>
                <a href="{% if t.source == 'twitter' %}https://twitter.com/search?q={{ t.keyword|urlencode }}{% else %}https://www.google.com/search?q={{ t.keyword|urlencode }}{% endif %}" target="_blank" rel="noopener">
                    <span class="trend-source trend-{{ t.source }}">{{ 'ğŸ¦' if t.source == 'twitter' else 'ğŸ”' }}</span>
                    {{ t.keyword }}
                </a>
            </li>
            {% else %}
            <li class="trends-empty">å†èª­è¾¼ã§ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å–å¾—ã—ã¾ã™</li>
            {% endfor %}
        </ul>
    </aside>
</div>

<section class="news-section">
    <p id="added-msg" class="added-msg" style="display:none; background:#d4edda; color:#155724; padding:0.5rem 1rem; border-radius:4px; margin-bottom:1rem;">æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ä¸Šã®ã€Œæ³¨ç›®ã®1æœ¬ã€ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚</p>

    <h2 class="section-title">AIè§£èª¬ã¤ããƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªãƒãƒ¼ãƒˆ</h2>
    <div class="genre-tabs-wrap" role="tablist" aria-label="ã‚¸ãƒ£ãƒ³ãƒ«ã§çµã‚Šè¾¼ã¿">
        <div class="genre-tabs-scroll">
            {% for category, items in news_by_category %}
            <button type="button" class="genre-tab" role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="panel-{{ category }}" id="tab-{{ category }}" data-cat="{{ category }}">{{ category }}</button>
            {% else %}
            <span class="category-empty" id="empty-state">èª­ã¿è¾¼ã¿ä¸­</span>
            {% endfor %}
        </div>
    </div>
    <div class="genre-panels">
        {% for category, items in news_by_category %}
        <div id="panel-{{ category }}" class="genre-panel" role="tabpanel" aria-labelledby="tab-{{ category }}" {% if not loop.first %}hidden{% endif %}>
            <h3 class="category-heading">{{ category }}</h3>
            <div class="news-grid news-grid-cards">
                {% for item in items %}
                <article class="news-card">
                    <a href="/topic/{{ item.id }}" class="news-card-link">
                        <div class="news-card-image">
                            <img src="{{ item.image_url or 'https://picsum.photos/400/225' }}" 
                                 alt="{{ item.title }}" 
                                 loading="lazy"
                                 onerror="this.src='https://picsum.photos/seed/{{ item.id }}/400/225'">
                        </div>
                        <div class="news-card-body">
                            <span class="news-source">{{ item.source }}</span>
                            <h3 class="news-title">{{ item.title }}</h3>
                            <p class="news-summary">{{ item.summary[:120] }}{% if item.summary|length > 120 %}...{% endif %}</p>
                            <span class="news-badge">AIè§£èª¬</span>
                        </div>
                    </a>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if pagination and pagination.total_pages > 1 %}
    <nav class="pagination" aria-label="ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³">
        <div class="pagination-info">
            {{ pagination.total }}ä»¶ä¸­ {{ (pagination.page - 1) * pagination.per_page + 1 }}â€“{{ [pagination.page * pagination.per_page, pagination.total]|min }}ä»¶ç›®
        </div>
        <ul class="pagination-list">
            {% if pagination.has_prev %}
            <li><a href="/?page={{ pagination.page - 1 }}" class="pagination-prev">â† å‰ã¸</a></li>
            {% endif %}
            <li><span class="pagination-current" aria-current="page">{{ pagination.page }} / {{ pagination.total_pages }}</span></li>
            {% if pagination.has_next %}
            <li><a href="/?page={{ pagination.page + 1 }}" class="pagination-next">æ¬¡ã¸ â†’</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
    if (window.location.search.indexOf('added=1') !== -1) {
        var el = document.getElementById('added-msg');
        if (el) el.style.display = 'block';
        history.replaceState(null, '', window.location.pathname);
    }

    // ã‚¸ãƒ£ãƒ³ãƒ«ã‚¿ãƒ–åˆ‡æ›¿ ï¼‹ ã‚¹ãƒ¯ã‚¤ãƒ—
    var tabs = document.querySelectorAll('.genre-tab');
    var panels = document.querySelectorAll('.genre-panel');
    var scrollEl = document.querySelector('.genre-tabs-scroll');
    if (tabs.length && panels.length) {
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                var cat = this.getAttribute('data-cat');
                tabs.forEach(function(t) { t.setAttribute('aria-selected', t === tab ? 'true' : 'false'); t.classList.toggle('is-active', t === tab); });
                panels.forEach(function(p) {
                    var show = p.id === 'panel-' + cat;
                    p.hidden = !show;
                });
                if (scrollEl) {
                    var tabLeft = tab.offsetLeft;
                    scrollEl.scrollTo({ left: tabLeft - scrollEl.offsetWidth / 2 + tab.offsetWidth / 2, behavior: 'smooth' });
                }
            });
        });
        // ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆã‚¿ãƒƒãƒï¼‰
        var startX = 0, currentIdx = 0;
        var panelList = Array.prototype.slice.call(panels);
        document.querySelector('.genre-panels').addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            currentIdx = panelList.findIndex(function(p) { return !p.hidden; });
        }, { passive: true });
        document.querySelector('.genre-panels').addEventListener('touchend', function(e) {
            var dx = e.changedTouches[0].clientX - startX;
            if (Math.abs(dx) < 50) return;
            var next = dx < 0 ? Math.min(currentIdx + 1, tabs.length - 1) : Math.max(currentIdx - 1, 0);
            if (next !== currentIdx && tabs[next]) tabs[next].click();
        }, { passive: true });
        // åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–
        document.querySelector('.genre-tab[aria-selected="true"]')?.classList.add('is-active');
    }

    // è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹ï¼šRSSã®æœ€æ–°1ä»¶ã‚’èª­ã¿è¾¼ã¿ã€AIãƒŸãƒ‰ãƒ«ãƒãƒ³ãŒè§£èª¬ã—ãŸè¨˜äº‹ã‚’1ä»¶è¿½åŠ ãƒ»å†ç”Ÿæˆ
    var btnAdd = document.getElementById('btn-add-article');
    if (btnAdd) {
        btnAdd.addEventListener('click', function() {
            btnAdd.disabled = true;
            btnAdd.textContent = 'æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ä¸­...';
            var slowMsg = setTimeout(function() {
                if (btnAdd.disabled) btnAdd.textContent = 'AIãŒè§£èª¬ä¸­ï¼ˆ1ã€œ2åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰...';
            }, 8000);
            fetch('/api/article/force-add-one')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    clearTimeout(slowMsg);
                    if (data.status === 'ok' && data.article_id) {
                        window.location.href = '/?added=1';
                    } else {
                        btnAdd.disabled = false;
                        btnAdd.textContent = 'æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’è¿½åŠ ';
                        var errMsg = data.message || (typeof data.detail === 'string' ? data.detail : '') || (Array.isArray(data.detail) ? data.detail.map(function(d){ return d.msg || d.loc; }).filter(Boolean).join(', ') : '') || 'å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        alert(errMsg);
                    }
                })
                .catch(function() {
                    clearTimeout(slowMsg);
                    btnAdd.disabled = false;
                    btnAdd.textContent = 'æ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’è¿½åŠ ';
                    alert('å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        });
    }

    // æ‰‹å‹•ã§RSSå–å¾—ï¼ˆ1ä»¶ã ã‘è¨˜äº‹åŒ–ï¼‰
    var btnRssOne = document.getElementById('btn-rss-one');
    if (btnRssOne) {
        btnRssOne.addEventListener('click', function() {
            btnRssOne.disabled = true;
            btnRssOne.textContent = 'RSSå–å¾—ä¸­...';
            var slowMsg = setTimeout(function() {
                if (btnRssOne.disabled) btnRssOne.textContent = 'AIè§£èª¬ä¸­...';
            }, 5000);
            fetch('/api/article/seed-one')
                .then(function(r) {
                    if (!r.ok) return r.text().then(function(t) { throw new Error(r.status + ': ' + (t || r.statusText)); });
                    return r.json();
                })
                .then(function(data) {
                    clearTimeout(slowMsg);
                    btnRssOne.disabled = false;
                    btnRssOne.textContent = 'æ‰‹å‹•ã§RSSå–å¾—ï¼ˆ1ä»¶ï¼‰';
                    if (data.status === 'ok' && data.article_id) {
                        document.getElementById('added-msg').style.display = 'block';
                        window.location.reload();
                    } else if (data.status === 'none') {
                        alert(data.message || 'å–ã‚Šè¾¼ã‚ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    } else {
                        alert(data.message || 'å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                })
                .catch(function(err) {
                    clearTimeout(slowMsg);
                    btnRssOne.disabled = false;
                    btnRssOne.textContent = 'æ‰‹å‹•ã§RSSå–å¾—ï¼ˆ1ä»¶ï¼‰';
                    var msg = (err && err.message) ? err.message : 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    if (msg === 'Failed to fetch' || msg.indexOf('NetworkError') !== -1) {
                        msg = 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã—ã¦ã„ã‚‹ã‹ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰';
                    }
                    alert(msg);
                });
        });
    }

    var empty = document.getElementById('empty-state');
    if (empty && document.querySelectorAll('.news-card').length === 0) {
        setTimeout(function() {
            fetch('/api/status').then(function(r) { return r.json(); }).then(function(d) {
                if (d.displayable === 0) {
                    var msg = 'ãƒªãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    if (!d.openai_key_set) {
                        msg += '.envã«OPENAI_API_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        msg += ' ã€Œæ–°ã—ã„ãƒªãƒãƒ¼ãƒˆã‚’è¿½åŠ ã€ã§æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIè§£èª¬ä»˜ãã§å–ã‚Šè¾¼ã‚ã¾ã™ã€‚';
                    }
                    empty.innerHTML = msg;
                }
            });
        }, 500);
    }
})();
</script>
{% endblock %}

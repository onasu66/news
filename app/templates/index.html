{% extends "base.html" %}
{% block title %}ãƒ›ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ - ä»Šè©±é¡Œã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’AIãŒè§£èª¬{% endblock %}

{% block content %}
<div class="page-top">
    <div class="hero">
        <span class="hero-badge">AIè§£èª¬ä»˜ã</span>
        <h1>ä»Šã€è©±é¡Œã®ãƒ‹ãƒ¥ãƒ¼ã‚¹</h1>
        <p class="hero-desc">Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€NHKã€Reutersãªã©ä¿¡é ¼ã§ãã‚‹ãƒ¡ãƒ‡ã‚£ã‚¢ã‹ã‚‰åé›†ã—ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã€é›£ã—ã„éƒ¨åˆ†ã¯AIãŒåˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã€‚æ¯æ—¥æ›´æ–°ã§æœ€æ–°ã®è©±é¡Œã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚</p>
        <button type="button" id="btn-add-article" class="btn-add-article">è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹</button>

        <div class="added-one-box">
            <h2 class="added-one-title">è¿½åŠ ã—ãŸ1ä»¶</h2>
            {% if added_one %}
            <article class="added-one-card">
                <a href="/article/{{ added_one.id }}" class="added-one-link">
                    <div class="added-one-image">
                        <img src="{{ added_one.image_url or 'https://picsum.photos/400/225' }}" alt="{{ added_one.title }}" loading="lazy" onerror="this.src='https://picsum.photos/seed/{{ added_one.id }}/400/225'">
                    </div>
                    <div class="added-one-body">
                        <span class="added-one-source">{{ added_one.source }}</span>
                        <h3 class="added-one-heading">{{ added_one.title }}</h3>
                        <p class="added-one-summary">{{ added_one.summary[:160] }}{% if added_one.summary|length > 160 %}...{% endif %}</p>
                        <span class="added-one-badge">AIè§£èª¬ã‚ã‚Š</span>
                    </div>
                </a>
            </article>
            {% else %}
            <p class="added-one-empty">ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§RSSã®æœ€æ–°1ä»¶ã‚’å–ã‚Šè¾¼ã‚ã¾ã™ã€‚</p>
            {% endif %}
        </div>
    </div>

    <aside class="trends-sidebar">
        <h2 class="sidebar-title">
            <span class="icon-fire">ğŸ”¥</span> æ€¥ä¸Šæ˜‡ãƒ¯ãƒ¼ãƒ‰
        </h2>
        <ul class="trends-list">
            {% for t in trends %}
            <li>
                <a href="{% if t.source == 'twitter' %}https://twitter.com/search?q={{ t.keyword|urlencode }}{% else %}https://www.google.com/search?q={{ t.keyword|urlencode }}{% endif %}" target="_blank" rel="noopener">
                    <span class="trend-source trend-{{ t.source }}">{{ 'ğŸ¦' if t.source == 'twitter' else 'ğŸ”' }}</span>
                    {{ t.keyword }}
                </a>
            </li>
            {% else %}
            <li class="trends-empty">å†èª­è¾¼ã§å–å¾—ã‚’è©¦ã¿ã¾ã™</li>
            {% endfor %}
        </ul>
    </aside>
</div>

<section class="news-section">
    <p id="added-msg" class="added-msg" style="display:none; background:#d4edda; color:#155724; padding:0.5rem 1rem; border-radius:4px; margin-bottom:1rem;">è¨˜äº‹ã‚’1ä»¶è¿½åŠ ã—ã¾ã—ãŸã€‚ä¸Šã®ã€Œè¿½åŠ ã—ãŸ1ä»¶ã€ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚</p>

    <h2 class="section-title">æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
    <nav class="category-nav" aria-label="ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§">
        {% for category, items in news_by_category %}
        <a href="#cat-{{ category }}" class="category-tab">{{ category }}</a>
        {% else %}
        <span class="category-empty" id="empty-state">èª­ã¿è¾¼ã¿ä¸­</span>
        {% endfor %}
    </nav>
    {% for category, items in news_by_category %}
    <div id="cat-{{ category }}" class="category-block">
        <h3 class="category-heading">{{ category }}</h3>
        <div class="news-grid">
            {% for item in items %}
            <article class="news-card">
                <a href="/article/{{ item.id }}" class="news-card-link">
                    <div class="news-card-image">
                        <img src="{{ item.image_url or 'https://picsum.photos/400/225' }}" 
                             alt="{{ item.title }}" 
                             loading="lazy"
                             onerror="this.src='https://picsum.photos/seed/{{ item.id }}/400/225'">
                    </div>
                    <div class="news-card-body">
                        <span class="news-source">{{ item.source }}</span>
                        <h3 class="news-title">{{ item.title }}</h3>
                        <p class="news-summary">{{ item.summary[:120] }}{% if item.summary|length > 120 %}...{% endif %}</p>
                        <span class="news-badge">AIè§£èª¬ã‚ã‚Š</span>
                    </div>
                </a>
            </article>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    {% if pagination and pagination.total_pages > 1 %}
    <nav class="pagination" aria-label="ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³">
        <div class="pagination-info">
            {{ pagination.total }}ä»¶ä¸­ {{ (pagination.page - 1) * pagination.per_page + 1 }}â€“{{ [pagination.page * pagination.per_page, pagination.total]|min }}ä»¶ç›®
        </div>
        <ul class="pagination-list">
            {% if pagination.has_prev %}
            <li><a href="/?page={{ pagination.page - 1 }}" class="pagination-prev">â† å‰ã¸</a></li>
            {% endif %}
            <li><span class="pagination-current" aria-current="page">{{ pagination.page }} / {{ pagination.total_pages }}</span></li>
            {% if pagination.has_next %}
            <li><a href="/?page={{ pagination.page + 1 }}" class="pagination-next">æ¬¡ã¸ â†’</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
    if (window.location.search.indexOf('added=1') !== -1) {
        var el = document.getElementById('added-msg');
        if (el) el.style.display = 'block';
        history.replaceState(null, '', window.location.pathname);
    }
    // è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹ï¼šRSSã®æœ€æ–°1ä»¶ã‚’èª­ã¿è¾¼ã¿ã€AIãƒŸãƒ‰ãƒ«ãƒãƒ³ãŒè§£èª¬ã—ãŸè¨˜äº‹ã‚’1ä»¶è¿½åŠ ãƒ»å†ç”Ÿæˆ
    var btnAdd = document.getElementById('btn-add-article');
    if (btnAdd) {
        btnAdd.addEventListener('click', function() {
            btnAdd.disabled = true;
            btnAdd.textContent = 'RSSã®æœ€æ–°1ä»¶ã‚’èª­ã¿è¾¼ã¿ä¸­...';
            var slowMsg = setTimeout(function() {
                if (btnAdd.disabled) btnAdd.textContent = 'RSSå–å¾—ãƒ»AIè§£èª¬ä¸­ï¼ˆ1ã€œ2åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰...';
            }, 8000);
            fetch('/api/article/force-add-one')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    clearTimeout(slowMsg);
                    if (data.status === 'ok' && data.article_id) {
                        window.location.href = '/?added=1';
                    } else {
                        btnAdd.disabled = false;
                        btnAdd.textContent = 'è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹';
                        var errMsg = data.message || (typeof data.detail === 'string' ? data.detail : '') || (Array.isArray(data.detail) ? data.detail.map(function(d){ return d.msg || d.loc; }).filter(Boolean).join(', ') : '') || 'å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        alert(errMsg);
                    }
                })
                .catch(function() {
                    clearTimeout(slowMsg);
                    btnAdd.disabled = false;
                    btnAdd.textContent = 'è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹';
                    alert('å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        });
    }

    var empty = document.getElementById('empty-state');
    if (empty && document.querySelectorAll('.news-card').length === 0) {
        setTimeout(function() {
            fetch('/api/status').then(function(r) { return r.json(); }).then(function(d) {
                if (d.displayable === 0) {
                    var msg = 'è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    if (!d.openai_key_set) {
                        msg += '.envã«OPENAI_API_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        msg += ' ã€Œè¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§RSSã‹ã‚‰å–ã‚Šè¾¼ã‚ã¾ã™ã€‚';
                    }
                    empty.innerHTML = msg;
                }
            });
        }, 500);
    }
})();
</script>
{% endblock %}

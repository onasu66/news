# 記事にする基準（現在の仕様）

RSS から取得したエントリのうち、どのような条件で「サイトの記事」（AI解説付き・DB保存）として取り込むかをまとめています。

---

## 1. 記事化の「入口」：いつ・何件まで実行されるか

| きっかけ | 条件 | 1回あたりの記事化上限 | 使うロジック |
|----------|------|------------------------|--------------|
| **起動時シード** | キャッシュ（AI解説済み記事数）が **20件未満** のときだけ | **最大5件** | スコアリング（後述） |
| **スケジュール** | **0:00 / 9:30 / 12:30 / 20:00（JST）** の4回のみ | **最大5件** | スコアリング |
| **API: シード記事** | `GET /api/admin/seed-articles` を叩いたとき | **最大5件** | スコアリング |
| **API: ランダム** | `GET /api/article/seed-random?count=N`（N=1〜10、既定3） | **N件** | ランダム選択 |

- 4時間ごとの interval では **RSS→記事化は行わず**、既存キャッシュの再読込のみ。
- Render などで `DISABLE_RSS_AND_AI` または `RENDER=true` のときは、上記の記事化処理は動きません。

---

## 2. RSS の取得元（RSS_FEEDS）

記事の「候補」は次の9サイトの RSS から取得します（各フィード最大50件まで取りにいき、全体で日付ソート後 200 件まで）。

| URL | 表示名 | 初期ジャンル |
|-----|--------|--------------|
| NHK（cat0.xml） | NHK | 国内 |
| 共同通信（英語版） | 共同通信 | 国際 |
| Reuters topNews | Reuters | 国際 |
| AP News | AP News | 国際 |
| Yahoo!ニュース トピックス | Yahoo!ニュース | 総合 |
| BBC News | BBC News | 国際 |
| 読売オンライン トップ | 読売新聞オンライン | 政治・社会 |
| World News International | World News International | 国際 |
| Le Monde トップ | Le Monde | 国際 |

- **総合**ソース（Yahoo!など）は、タイトルに含まれるキーワードでジャンルを上書きします（スポーツ／エンタメ／テクノロジーなど）。
- 環境変数 `FULLTEXT_RSS_BASE_URL` を設定している場合は、上記 URL を Full-Text RSS 経由の URL に差し替えて取得します。

---

## 3. 軽量フィルタ（ここを通過しないと記事化の候補にならない）

`keyword_scorer.lightweight_filter` で、次のいずれかに当てはまるものは **候補から除外** されます。

### 3.1 必須条件

- **文字数**  
  - タイトル＋要約（summary）を結合したテキストが **80文字未満** の場合は除外。  
  - 定数: `MIN_CONTENT_LENGTH = 80`

### 3.2 ジャンルによる除外

- **ジャンルが「スポーツ」「エンタメ」** の場合は原則除外。
- **例外（救済）**: タイトルまたは要約に **高価値キーワード**（下記）が1つでも含まれていれば通過。

### 3.3 タイトルによる除外

- タイトルが次のいずれかに **マッチする** 場合は原則除外（正規表現）:
  - 号外 / 訃報 / 結果 / スコア / 芸能 / ランキング / 占い / 星座 / ゴシップ
  - 英語: `breaking` / `score` / `results` / `obituary` / `gossip` など
- **例外（救済）**: 同上、タイトル＋要約に **高価値キーワード** が1つでもあれば通過。

### 3.4 高価値キーワード（救済用）

次のいずれかがタイトルまたは要約に含まれていれば、上記の「スポーツ・エンタメ」「タイトルパターン」による除外を免れます。

- 日本語: 政策 / 法案 / 経済 / 規制 / 金利 / インフレ / GDP / 予算 / 制裁 / 半導体 / AI / 量子 / 脱炭素 / 再生可能エネルギー / 外交 / 安全保障 / サミット / 条約 / 改革 / 選挙 / 判決 / 裁判 / 汚職 / 調査
- 英語: policy / regulation / economy / inflation / legislation / sanctions / semiconductor / quantum / climate / diplomacy / summit / reform / election / ruling / investigation

---

## 4. スコアリング（スケジュール・シード記事で使う選び方）

「軽量フィルタ通過」した候補に対して、**スコア** を付け、上位から記事化します。

### 4.1 スコアの内訳（`score_article`）

- **Google Autocomplete スコア**  
  - タイトル＋要約からキーワード（1-gram / 2-gram / 疑問形バリエーション）を抽出し、Google サジェスト API で検索候補数を取得して加算。  
  - 2-gram は 1.5 倍、疑問形は 2.0 倍で重み付け。
- **高価値キーワードボーナス**  
  - 上記の高価値キーワードがタイトル＋要約に1つ含まれるごとに **+3**。
- **トレンドボーナス**  
  - Google トレンド・X 急上昇のキーワードがタイトル＋要約に含まれるごとに **+5**。  
  - トレンドキーワードは、その回の `get_trends()` の結果を使用。

### 4.2 候補の絞り方（`rank_and_filter_articles`）

1. 軽量フィルタ通過したものだけを対象にする。
2. 上記スコアで降順ソート。
3. **上位 `max_articles` 件** を採用（スケジュール・シードのときは `max_per_run * 3`＝15件を候補にし、その後の重複排除・順序で最終的に **最大5件** を記事化）。

---

## 5. 重複排除（同一内容は1本だけ）

- **既存記事との重複**  
  - すでに DB に保存されている記事のタイトルを「正規化」（空白・記号除去・小文字化など）した集合と照合。  
  - 正規化タイトルが一致する候補は **採用しない**。
- **候補どうしの重複**  
  - 同じ正規化タイトルの候補が複数ある場合は、**スコア上位1件だけ** を残す（ランダムのときはシャッフル後の先頭1件）。

正規化は `_normalize_title_for_dedup`（空白正規化・記号除去・小文字化）で行います。

---

## 6. ランダム選択（`/api/article/seed-random`）の基準

- 軽量フィルタを **通過** していること。
- **まだ記事化されていない**（`get_cached_article_ids()` に含まれていない）こと。
- 既存記事・候補内で **正規化タイトルが重複していない** こと。
- 上記を満たす候補を **ランダムにシャッフル** し、先頭から **count 件**（1〜10、既定3）を記事化。

スコアリングは使わず、通過した候補から均等に選びます。

---

## 7. 記事化の最終段階（1本ずつ）

候補として選ばれた1件について、次の処理で「サイト記事」にします。

1. **既に解説済みか**  
   - `force=False` のとき、すでに `get_cached(item.id)` で解説があれば **スキップ**（記事化しない）。
2. **海外記事**  
   - ソースまたは本文が「海外」と判定された場合は、タイトル・要約を日本語に翻訳・言い換え（`translate_and_rewrite`）。
3. **タイトル整形**  
   - 【】で始まっていなければ、ルールに従って【なぜ】【解説】などのラベルを付与（`_add_bracket_title`）。
4. **本文取得**  
   - 記事URLから本文を取得（`fetch_article_body`）。取得できれば要約と結合し、海外なら本文も翻訳。
5. **AI解説生成**  
   - `generate_all_explanations` でミドルマン解説＋5人格の意見を生成。
6. **保存**  
   - 解説を `save_cache`、記事を `save_article` で保存（Firestore または SQLite）。  
   - ここまで成功した場合のみ「記事になった」とカウントされます。

このいずれかで失敗したり、ブロックが空だったりすると、その候補は記事化されません（ログ用の保存履歴には「保存なし・失敗」として記録されます）。

---

## 8. まとめ：記事になるまでの条件一覧

- RSS の取得元は上記 9 フィード（＋ Full-Text RSS オプション）。
- **軽量フィルタ**を通過（80文字以上、スポーツ/エンタメ・低価値タイトルは高価値キーワードで救済可能）。
- **スケジュール／シード**のときは、さらに **スコア**（Autocomplete＋高価値＋トレンド）で上位を選択。**ランダム**のときはスコアを使わず通過候補からランダムに選択。
- **重複排除**：既存記事・候補内で正規化タイトルが同じものは1本だけ。
- 1回の実行では **最大5件**（ランダムのときは指定した count 件）までを、1本ずつ「AI解説生成 → 保存」まで実行。
- 実行タイミングは **起動時（キャッシュ20件未満のとき）** と **0:00 / 9:30 / 12:30 / 20:00 JST** および **手動API**。

以上が、現在の「記事にする基準」の全体です。
